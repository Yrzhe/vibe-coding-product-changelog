version: '3.8'

services:
  # Web 前端服务
  web:
    build: ./webapp
    image: product-changelog-viewer:latest
    container_name: changelog-viewer
    ports:
      - "8999:80"
    volumes:
      - ./storage:/usr/share/nginx/html/data/storage:ro
      - ./info:/usr/share/nginx/html/data/info:ro
      - ./logs:/usr/share/nginx/html/data/logs:ro
    depends_on:
      - api
    restart: unless-stopped

  # API 服务（支持 Admin 页面、手动触发和脚本执行）
  api:
    build: ./script
    image: changelog-api:latest
    container_name: changelog-api
    ports:
      - "3003:3003"
    volumes:
      - ./storage:/app/storage
      - ./info:/app/info
      - ./logs:/app/logs
      - ./script/prompts:/app/prompts
    environment:
      - TZ=Asia/Shanghai
      - PYTHONUNBUFFERED=1
    command: python3 api_server.py
    restart: unless-stopped

  # 定时监控服务（每天自动爬取更新）
  scheduler:
    build: ./script
    image: changelog-scheduler:latest
    container_name: changelog-scheduler
    volumes:
      - ./storage:/app/storage
      - ./info:/app/info
      - ./logs:/app/logs
      - ./script/prompts:/app/prompts
    environment:
      - TZ=Asia/Shanghai
      - PYTHONUNBUFFERED=1
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        echo "Setting up cron job..."
        # 设置完整的环境变量，确保 cron 能找到 Python 和已安装的包
        echo "PATH=/usr/local/bin:/usr/bin:/bin" > /etc/cron.d/monitor-cron
        echo "PYTHONPATH=/usr/local/lib/python3.11/site-packages" >> /etc/cron.d/monitor-cron
        echo "PLAYWRIGHT_BROWSERS_PATH=/ms-playwright" >> /etc/cron.d/monitor-cron
        echo "0 9 * * * root cd /app && /usr/local/bin/python3 monitor.py >> /app/logs/cron.log 2>&1" >> /etc/cron.d/monitor-cron
        chmod 0644 /etc/cron.d/monitor-cron
        echo "Cron scheduled: daily at 09:00 (Asia/Shanghai)"
        echo "Starting cron daemon..."
        cron -f
    restart: unless-stopped
